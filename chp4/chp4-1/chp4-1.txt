第4章 Firebirdを使ってみよう

前章でFirebirdをインストールしました。それでは実際に、IBConsoleを利用してFirebirdを利用していきましょう。ここでは筆者のコンパイルした日本語文字列を表示できるIBConsoleを利用しています。

4-1.IBConsoleの使い方
IBConsoleを起動した時点（図4-1-1)ではサーバーは登録されていません。ここではIBConsoleが起動しているWindowsマシンにFirebirdがインストールされているものとして説明していきます。

図4-1-1.IBConsoleを起動したところ
（chp4-1-1.bmp)

a)サーバーの登録
IBConsoleでサーバー管理を行うにはサーバーの登録が必要です。[Server]-[Register...]メニューを選択し、[Register Server and Connect]ダイアログボックスを表示します（図4-1-2)。同一環境のマシンに接続する場合は、[Local Server]を、リモートサーバーに接続する場合は[Remote Server]を選択します。リモートサーバーの場合は、Server Nameおよびプロトコルを選択します。プロトコルはTCP/IP,SPX(Netware環境のみ),NETBEUI(Windows環境のみ）が選択できますが、Windows環境であってもTCP/IPを選択することをお奨めします。リモート環境の場合は、Aliasの設定にて自分の好きな名前を設定として登録することができます。また、Descriptionのテキストボックスには接続先のサーバーの説明などを記載してください。
[Login Information]にはユーザー名とパスワードを指定します。Firebirdの管理者ユーザーは"SYSDBA"で、インストールされた状態ではパスワードは"masterkey"になっています。できるだけ早い時期にSYSDBAのパスワードを変更してください。[OK]ボタンを押すと、図4-1-3のようにLocal Serverが登録され、サーバーに接続されます。もし、サーバーが起動されていない場合は、起動するかどうかの確認メッセージが表示されます。

図4-1-2.[Register Server and Connect]ダイアログボックス
(chp4-1-2.bmp)

図4-1-3.Local Serverが追加されたところ
(chp4-1-3.bmp)

Local Serverをダブルクリックすると、図4-1-4のように詳細情報が表示されます。まずは管理者（SYSDBA)のパスワードを変更してみましょう。[Server]-[User Security]で[User Information]ダイアログボックス(図4-1-5)を表示します。[Password]と[Confirm Password]に新しいパスワードを入れ、[Apply]ボタンを押すとパスワードが変更されます。新規にユーザーを作成したい場合は、[New]ボタンを押して同様の処理を行います。Firebirdはisc4.gdbという特殊なデータベースファイルにてユーザーを管理しています。こちらのファイルが壊れてしまうとサーバーにログインできなくなりますので、定期的にバックアップを取っておくことをお奨めします。


図4-1-4.登録されているサーバーの情報
(chp4-1-4.bmp)

図4-1-5.[User Information]ダイアログボックス
(chp4-1-5.bmp)

b)データベースの登録
続いて、IBConsoleでデータベースの管理ができるようにデータベースの登録を行ってみましょう。まずは、Firebirdに納められているサンプルデータベースを登録します。[Database]-[Register]メニューを選択して、[Register Database and Connect]ダイアログボックスを表示します。こちらのダイアログボックスで、Firebirdに付属するEMPLOYEEデータベース(C:\program files\firebird\examples\employee.gdb)を[File]項目で選択し、[Alias Name]に分かりやすいエリアス名をつけて、[OK]ボタンを押します。もし、他のユーザーで接続したいときは[User Name]と[Password]を指定します。グループに権限がつけられるロール(Role）は別の機会で説明します。登録された状態ではデータベースと接続されていません。接続するにはエリアス名（従業員データベース）をダブルクリックすると現在サーバーにログインしているユーザーで（ここではSYSDBA）、データベースに接続されます。接続されていると、各スキーマオブジェクトのメニューが表示されます（図4-1-7)。

図4-1-6.[Register Database and Connect]ダイアログボックス
(chp4-1-6.bmp)

図4-1-7.EMPLOYEEデータベースに接続したところ
(chp4-1-7.bmp)


c)オブジェクトの閲覧
スキーマオブジェクトのメニューから[Tables]を選択してみましょう。図4-1-8のようにEMPLOYEEデータベースに格納されているテーブルが右側に表示されます。ここから、テーブルを選んでダブルクリックを行うと、図4-1-9のように選択されたテーブル（ここではEMPLOYEEテーブル）のプロパティダイアログボックスが表示されます。

図4-1-8.登録されているテーブル
(chp4-1-8.bmp)

図4-1-9.EMPLOYEEテーブルのプロパティ
(chp4-1-9.bmp)

このプロパティダイアログボックスではテーブルの構造や現在格納されているデータ、パーミッション、インデックスとの関係などを表示することができます。プロパティダイアログボックスの上部のリストボックスでテーブル名を選択することで、他のテーブルについても同様に閲覧することができます。

図4-1-10.EMPLOYEEテーブルのデータ閲覧
（chp4-1-10.bmp)

IBConsoleではテーブルだけでなく、データベースに格納されているビュー、ストアドプロシージャ、ジェネレータ、ロール、BLOBフィルタなど、すべてのオブジェクトを閲覧することができます。


e)データベースのメタデータの閲覧
プロパティダイアログボックスでは、各オブジェクトのメタデータを閲覧することができますが、[Database]-[View Metadata]メニューを選択することで、EMPLOYEEデータベースのすべてのメタデータを閲覧および保存することができます（図4-1-11）。こちらのメタデータを保存しておくと、EMPLOYEEデータベースとまったく同じ構造のデータベースを作成することができます。

図4-1-11.EMPLOYEEデータベースのメタデータ
(chp4-1-11.bmp)


f)データベースのバックアップ
データベースのバックアップは[Database]-[Maintenance]-[Backup/Restore]-[Backup]メニューを選択して表示される[Database Backup]ダイアログボックス(図4-1-12)にて行います。こちらのダイアログボックスでは、登録されているエリアスを選択し、バックアップ先のエリアスを設定してバックアップを行います。バックアップ先のエリアスは登録されているエリアスを選択することもできますが、新規に作成することをお奨めします。ここでは、[従業員データベースのバックアップ]というエリアスを設定しています。ファイル名を指定し、バックアップ先を設定します。
また、別のサーバー上にバックアップを行うことも可能ですが、ネットワークトラフィックが非常に高くなるのでお奨めできません。
バックアップ時にオプションを設定することができます。各オプションの意味は次の通りです。

	i)Format: リビジョンやサーバーのバージョンが異なるときに移行可能な形式にするかどうかを指定します。デフォルトは"Transportable"で移行可能な形式です。製品のバージョンアップやリビジョンアップを行うときは必ずこの"Tansportable"形式を選択する必要があります。
	
	ii)	Metadata Only:データを移行するかどうかを指定します。デフォルトは"False"でメタデータとデータの両方をバックアップします。構造のみ（メタデータ）をバックアップしたいときときは"True"を設定してバックアップを実行します。

	iii)Garbage Collection: バックアップを行うときにデータベース領域の末尾の空き領域を削除してサイズを小さくするかどうかを指定します。すでに説明したように、Firebirdはデータの削除などで空き領域が発生するとデータベースの末尾に移動させ再利用します。デフォルトは"True"でガーベージコレクションを行います。
	iv)Transactions in Limbo:システムのトラブルや２フェーズコミットが行えずに、コミットもロールバックもされていないトランザクションをリンボトランザクションといいます。このトランザクションを処理するかどうかを指定します。デフォルトは"Process"で処理を行います。バックアップを行う前にデータベースの検査を行ってリンボトランザクションがないかどうかを確認するのが理想です。

	v)checksums:バックアップを行うときにチェックサムを行うかを指定します。デフォルトは"Process"でチェックサムを行います。

	vi)Convert to Table:外部ファイルを内部ファイルにコンバートするかどうかを指定します。Firebirdではテキスト形式のファイルを外部ファイルとして使用することができ、バックアップのタイミングで外部ファイルを内部ファイルとして取り込むことができます。デフォルトは"False"で取り込みを行いません。

	vii)VerboseOutput：バックアップの処理経過を画面やファイルに出力するかを指定します。デフォルトは"To Screen"で画面に出力します。

図4-1-12.[Database Backup]ダイアログボックス
（chp4-1-12.bmp)

すべての設定が終了し、[OK]ボタンを押すと図4-1-13のような[Database Backup]ダイアログボックスが表示され、バックアップの経過が画面上に出力されます。こちらの画面にて、バックアップ終了後にエラーが発生していないかを確認し、バックアップ処理を終了します。バックアップが行われるIBConsoleの[Backup]のメニューに追加したエリアスが表示されます（図4-1-14)。IBConsoleではこのようにバックアップ元とバックアップ先がきちんと保存されるようになっています。

図4-1-13.[Database Backup]ダイアログボックス
(chp4-1-13.bmp)

図4-1-14.[Backup]メニュー
(chp4-1-14.bmp)


g)データベースの復元
データベースの復元はバックアップとまったく反対の処理となります。[Database]-[Maintenance]-[Backup/Restore]-[Restore]メニューを選択して表示される[Database Restore]ダイアログボックス（図4-1-15)で行います。こちらのダイアログボックスで復元先のエリアスを指定します。バックアップと同様に別サーバー上に復元することもできますが、ネットワーク負荷が高くなるので、異なるサーバーで復元を行いたいときは、バックアップファイルを移行してから行うことをお奨めします。
オプションでは次の項目が指定できます。

図4-1-15.[Database Restore]ダイアログボックス
(chp4-1-15.bmp)

	i)Page Size:Firebirdがデータベースを扱うときの最小のI/Oの単位であるページサイズを指定します。サイズはKB単位となっており、1024,2048,5096,8192が選択できます。ページサイズを大きくするとデータベースのサイズが大きくなりますが、キャッシュされるデータ数が多くなりますのでパフォーマンスが早くなります。8192を使用するのがいいでしょう。デフォルトは1024となっています。

	ii)Overwrite：データベースを上書きするかどうかを指定します。デフォルトは"False"で上書きを行いません。

	iii)Commit After Each Table：データベースの復元を行っているときに、各テーブルごとでコミット処理を行うかを指定します。デフォルトは"False"でデータベースの復元が終了した時点でコミット処理を行います。

	iv)Create Shadow Files：シャドウファイルの設定がされているときにシャドウファイルを作成するかどうかを指定います。デフォルトは"True"でシャドウファイルの作成を行います。

	v)Deactive indices：復元後にインデックスを無効にするかどうかを指定します。復元後に大規模なデータの削除・更新・追加を行う場合はこの設定を"True"にし、データ処理が行われた後に、ALTER INDEX文でインデックスを有効にすることをお奨めします。デフォルトは"False"となっています。

	vi)Validity Conditions：整合性検査を復元するかどうかを指定します。デフォルトは"Restore"で復元を行います。

	vii)Use All Space：デフォルトでは各ページに80%の割合でデータを格納しますが、このオプションを"True"にすると100%の割合でデータを格納します。

	viii)VerboseOutput：復元の処理経過を画面やファイルに出力するかを指定します。デフォルトは"To Screen"で画面に出力します。

[OK]ボタンを押すと、バックアップと同様に経過を表示する[Database Restore]ダイアログボックスが表示されます。こちらのダイアログボックスで表示されたログを確認することで復元が成功したかどうかを確認することができます。


h)データベースの状態
[Database]-[Maintenance]-[Database Statistics]を選択することでデータベースの状態を閲覧することができます。メニューを選択すると、図4-1-16のような[Database Statistics]ダイアログボックスが表示され、どの項目を表示するかを選択できます。デフォルトは"All Options"となっており、すべての情報を表示します。[OK]ボタンを押すと、図4-1-17のようなチェックサム、ページサイズ、トランザクション数、各ページのデータの割合など、データベースの状態を詳細に表示した画面が出力されます。

図4-1-16.Database Statisticsのオプション設定
(chp4-1-16.bmp)

図4-1-17.データベースの状態
(chp4-1-17.bmp)


i)接続しているユーザーの表示
[Database]-[Connect Users]を選択すると、現在接続しているユーザーと接続数を表示します(図4-1-18)。

図4-1-18.接続しているユーザーの表示
(chp4-1-18.bmp)

まだまだ、IBConsoleには説明していない機能がありますが、基本的な機能はここで説明したとおりで、ここまでの内容を理解していればサーバー管理を行うことができるでしょう。

